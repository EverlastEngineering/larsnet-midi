# Module Split Plan: stems_to_midi.py → Multiple Focused Modules

**Date Created:** 2025-10-16  
**Status:** IMMUTABLE (Do not edit this file after creation)

## Objective

Split `stems_to_midi.py` (1568 lines) into 6 focused modules to improve:
- LLM context handling (each file < 450 lines)
- Code navigation and maintainability
- Testing and mocking capabilities
- Parallel development potential

## Current Structure

**stems_to_midi.py** (1568 lines, 13 functions):
- Configuration loading
- Data classes (DrumMapping)
- Detection functions (onsets, pitch, hihat, velocity)
- Main processing pipeline
- MIDI file operations
- Learning mode functions
- CLI orchestration

## Target Module Structure

### Module 1: `stems_to_midi_config.py` (~50 lines)
**Purpose:** Configuration and data structures  
**Functions:**
- `load_config(config_path) -> Dict`
- `DrumMapping` dataclass

**Dependencies:** yaml, pathlib, dataclasses  
**Imported by:** All other modules

---

### Module 2: `stems_to_midi_detection.py` (~250 lines)
**Purpose:** Audio analysis and detection algorithms  
**Functions:**
- `detect_onsets(audio, sr, ...) -> Tuple[ndarray, ndarray]`
- `detect_tom_pitch(audio, sr, onset_times, config) -> ndarray`
- `classify_tom_pitch(pitches) -> ndarray`
- `detect_hihat_state(audio, sr, onset_times, ...) -> List[str]`
- `estimate_velocity(strength, min_vel, max_vel) -> int`

**Dependencies:** librosa, numpy, scipy, sklearn, stems_to_midi_helpers, stems_to_midi_config  
**Imported by:** stems_to_midi_processor, stems_to_midi_learning

---

### Module 3: `stems_to_midi_processor.py` (~450 lines)
**Purpose:** Main processing pipeline (imperative shell)  
**Functions:**
- `process_stem_to_midi(audio_path, stem_type, ...) -> List[Dict]`

**Dependencies:** soundfile, numpy, stems_to_midi_helpers, stems_to_midi_config, stems_to_midi_detection  
**Imported by:** stems_to_midi (main orchestrator)

---

### Module 4: `stems_to_midi_midi.py` (~100 lines)
**Purpose:** MIDI file operations  
**Functions:**
- `create_midi_file(events_by_stem, output_path, ...) -> None`
- `read_midi_notes(midi_path, target_note) -> List[float]`

**Dependencies:** midiutil, mido, stems_to_midi_config  
**Imported by:** stems_to_midi, stems_to_midi_learning

---

### Module 5: `stems_to_midi_learning.py` (~450 lines)
**Purpose:** Learning mode and threshold calibration  
**Functions:**
- `learn_threshold_from_midi(audio_path, original_midi, edited_midi, ...) -> Dict[str, float]`
- `save_calibrated_config(config, learned_thresholds, output_path) -> None`

**Dependencies:** soundfile, numpy, librosa, stems_to_midi_helpers, stems_to_midi_config, stems_to_midi_detection  
**Imported by:** stems_to_midi (main orchestrator)

---

### Module 6: `stems_to_midi.py` (~350 lines - main entry point)
**Purpose:** CLI orchestration and main workflow  
**Functions:**
- `stems_to_midi(input_dir, output_dir, ...) -> None` - main orchestrator
- `main()` - CLI argument parsing

**Dependencies:** All above modules  
**Imported by:** CLI users, other scripts

---

## Execution Phases

### Phase 1: Create Module Structure ✅
- Create 5 new module files with docstrings
- Set up proper imports and dependencies
- Add `__all__` exports for public API
- **Tests:** Import tests (no functionality yet)
- **Commit:** "refactor(split): create module structure for stems_to_midi split"

### Phase 2: Extract Configuration Module ✅
- Move `load_config()` to `stems_to_midi_config.py`
- Move `DrumMapping` class to `stems_to_midi_config.py`
- Update imports in original file
- **Tests:** Config loading tests (should still pass)
- **Commit:** "refactor(split): extract config module"

### Phase 3: Extract Detection Module ✅
- Move all detection functions to `stems_to_midi_detection.py`
- Update imports and function signatures
- Update calls in processor
- **Tests:** All detection tests (should still pass)
- **Commit:** "refactor(split): extract detection module"

### Phase 4: Extract MIDI Module ✅
- Move MIDI functions to `stems_to_midi_midi.py`
- Update imports
- **Tests:** MIDI creation tests (should still pass)
- **Commit:** "refactor(split): extract MIDI module"

### Phase 5: Extract Learning Module ✅
- Move learning functions to `stems_to_midi_learning.py`
- Update imports
- **Tests:** All tests still passing
- **Commit:** "refactor(split): extract learning module"

### Phase 6: Extract Processor Module ✅
- Move `process_stem_to_midi()` to `stems_to_midi_processor.py`
- Update imports in main file
- **Tests:** Main processing tests (should still pass)
- **Commit:** "refactor(split): extract processor module"

### Phase 7: Clean Up Main File ✅
- Keep only orchestration and CLI in main file
- Simplify imports
- Update module docstring
- **Tests:** Full integration tests
- **Commit:** "refactor(split): finalize main orchestrator"

### Phase 8: Update Documentation ✅
- Update README.md with new module structure
- Update STEMS_TO_MIDI_GUIDE.md
- Add module dependency diagram
- **Commit:** "docs(split): update documentation for new module structure"

---

## Success Criteria

- ✅ All 47 tests still passing
- ✅ No functionality changes (pure refactoring)
- ✅ Each module < 450 lines
- ✅ Clear separation of concerns
- ✅ Minimal circular dependencies
- ✅ Public API unchanged (backward compatible)
- ✅ All imports work correctly
- ✅ Documentation updated

## Risk Assessment

### High Risk
- **Circular imports:** Detection may need config, processor needs detection
  - *Mitigation:* Careful dependency ordering, config at bottom of hierarchy

### Medium Risk
- **Breaking external imports:** Users importing specific functions
  - *Mitigation:* Keep re-exports in main `stems_to_midi.py` for backward compatibility

### Low Risk
- **Test failures:** Imports may need updating
  - *Mitigation:* Run tests after each phase

## Rollback Plan

If any phase fails:
1. Revert the last commit
2. Fix issues
3. Re-run tests
4. Retry the phase

## Timeline Estimate

- **Total Time:** 2-3 hours
- **Per Phase:** 15-25 minutes
- **Testing:** 5 minutes per phase

## Dependencies

- All existing dependencies (no new packages)
- Python's import system
- Existing test suite

## Notes

- This is a pure refactoring - zero functionality changes
- Follow the same commit workflow as Phases 1-7
- Each phase should pass all tests before committing
- Maintain backward compatibility through re-exports

---

**IMPORTANT:** This file should NOT be edited after creation. Track actual progress in `stems_to_midi_split.results.md`.
